# Gate-IP-Base Controller

## Описание проекта

Данный проект представляет собой программную имитацию СКУД считывателя **Gate-Reader-EH**, реализованную на языке Go. Проект позволяет работать с контроллерами доступа Gate-IP-Base через протокол Wiegand 26, используя GPIO пины Raspberry Pi.

### Основные возможности

1. **Считывание RFID карт** - приём данных от физического считывателя через протокол Wiegand
2. **Эмуляция считывателя** - отправка номеров карт в контроллер СКУД
3. **Блокировка считывателя** - физическая блокировка линий передачи данных (jamming)

---

## Системные требования

### Программное обеспечение
- **Go версия 1.23.5 и выше** (возможен запуск на более ранних версиях)
- Операционная система Linux (рекомендуется Raspberry Pi OS Lite)

### Аппаратное обеспечение
- **Raspberry Pi 3 Model B и выше**
  - ⚠️ **Внимание**: На Raspberry Pi 5 могут возникнуть проблемы совместимости ввиду изменения архитектуры процессора
- Архитектура: ARM (32-bit или 64-bit)
- Контроллер СКУД Gate-IP-Base

---

## Схема подключения

### Подключение Raspberry Pi к контроллеру Gate-IP-Base

| Raspberry Pi (физический пин) | Назначение | Контроллер Gate-IP-Base |
|-------------------------------|------------|-------------------------|
| **6** (GND)                   | Земля      | GND                     |
| **11** (GPIO 17)              | DATA0      | DATA0 (Wiegand)         |
| **13** (GPIO 27)              | DATA1      | DATA1 (Wiegand)         |

### Схема подключения (визуально)

```
Raspberry Pi                    Gate-IP-Base Controller
┌──────────────┐               ┌──────────────────────┐
│              │               │                      │
│  Pin 6 (GND) ├───────────────┤ GND                  │
│              │               │                      │
│ Pin 11 (GPIO17)├─────────────┤ DATA0 (Wiegand)      │
│              │               │                      │
│ Pin 13 (GPIO27)├─────────────┤ DATA1 (Wiegand)      │
│              │               │                      │
└──────────────┘               └──────────────────────┘
```

---

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone https://github.com/varavayka/gate-ip-base-controller.git
cd gate-ip-base-controller
```

### 2. Установка зависимостей

```bash
go mod download
```

### 3. Сборка проекта

```bash
go build -o gate-controller ./cmd/cli/main.go
```

### 4. Запуск программы

⚠️ **Требуются права root** для доступа к GPIO:

```bash
sudo ./gate-controller
```

---

## Использование

### Главное меню

При запуске программы отображается меню с тремя опциями:

```
Опции

[1] Считать rfid карту
[2] Отправить карту в контроллер
[3] Заблокировать считыватель

: 
```

### Режим 1: Считывание RFID карты

Программа переходит в режим ожидания прикладывания карты к физическому считывателю.

**Как это работает:**
- Программа слушает GPIO пины 17 (DATA0) и 27 (DATA1)
- При обнаружении импульсов собирает бинарную последовательность
- После таймаута (200 мс) декодирует данные по протоколу Wiegand 26
- Выводит номер карты в консоль

**Пример вывода:**
```
Ожидаю карту...
01011001110100101010110101
```

---

### Режим 2: Отправка карты в контроллер

Позволяет эмулировать прикладывание карты, отправляя данные напрямую в контроллер.

**Формат ввода:**
```
<код объекта>,<номер карты>
```

**Примеры:**
```
093,12176
090,76767
255,65535
```

**Важные правила:**
- ❌ Без пробелов
- ❌ Без специальных символов (кроме запятой)
- ✅ Код объекта (Facility Code): 0-255
- ✅ Номер карты: 0-65535

**Как это работает:**
1. Программа принимает номер карты в десятичном формате
2. Автоматически преобразует в бинарный код Wiegand 26
3. Вычисляет биты чётности (parity bits)
4. Отправляет импульсы на GPIO пины с правильными таймингами

**Технические параметры передачи:**
- Длительность импульса: 80 мкс
- Интервал между битами: 4 мс
- Формат: Wiegand 26 (1 бит чётности + 8 бит FC + 16 бит CN + 1 бит чётности)

---

### Режим 3: Блокировка считывателя (Jammer)

Физически блокирует работу подключённого считывателя путём прижатия линий DATA0 и DATA1 к земле.

**Управление:**
```
Введите команду (1/0): 1    # Заблокировать
[!!!] БЛОКИРОВКА АКТИВНА
Линии Data 0 и Data 1 прижаты к GND.
Считыватель физически не может передать данные.

Введите команду (1/0): 0    # Разблокировать
[OK] БЛОКИРОВКА СНЯТА
Линии свободны. Система работает в штатном режиме.
```

**Команды:**
- `1` - Активировать блокировку
- `0` - Снять блокировку
- `Ctrl+C` - Выход с автоматической разблокировкой

**Принцип работы:**
- При активации: GPIO пины переводятся в режим OUTPUT и устанавливаются в LOW (0V)
- При деактивации: GPIO пины переводятся в режим INPUT (высокоимпедансное состояние)

---

## Структура проекта

```
gate-ip-base-controller/
├── cmd/
│   ├── cli/
│   │   └── main.go              # Точка входа CLI приложения
│   ├── http/                    # (Зарезервировано для HTTP API)
│   └── telegram/                # (Зарезервировано для Telegram бота)
│
├── pkg/
│   └── wiegand/                 # Пакет для работы с протоколом Wiegand
│       ├── config.go            # Константы конфигурации (пины, таймауты)
│       ├── transmitter.go       # Отправка данных (эмуляция считывателя)
│       ├── receiver.go          # Приём данных (чтение карт)
│       ├── EncodeWiegand26.go   # Кодирование в формат Wiegand 26
│       └── jammer.go            # Блокировка считывателя
│
├── go.mod                       # Зависимости проекта
├── go.sum                       # Контрольные суммы зависимостей
└── README.md                    # Данная справка
```

---

## Технические детали

### Протокол Wiegand 26

**Структура данных (26 бит):**
```
[EP][FC FC FC FC FC FC FC FC][CN CN CN CN CN CN CN CN CN CN CN CN CN CN CN CN][OP]
 1    8 бит                    16 бит                                            1
```

Где:
- **EP** - Even Parity (бит чётности для первых 12 бит данных)
- **FC** - Facility Code (код объекта, 8 бит, 0-255)
- **CN** - Card Number (номер карты, 16 бит, 0-65535)
- **OP** - Odd Parity (бит нечётности для последних 12 бит данных)

### Конфигурация GPIO

Определена в `pkg/wiegand/config.go`:

```go
const (
    PinD0         = 17                    // GPIO 17 для DATA0
    PinD1         = 27                    // GPIO 27 для DATA1
    Timeout       = 200 * time.Millisecond // Таймаут между битами
    MinBits       = 24                    // Минимальное количество бит
    PulseDuration = 80 * time.Microsecond // Длительность импульса
    BitInterval   = 4 * time.Millisecond  // Интервал между битами
)
```

### Зависимости

- **github.com/stianeikeland/go-rpio/v4** (v4.6.0) - библиотека для работы с GPIO на Raspberry Pi

---

## Примеры использования

### Пример 1: Считывание карты

```bash
sudo ./gate-controller
# Выбираем опцию [1]
1
Ожидаю карту...
# Прикладываем карту к физическому считывателю
01011001110100101010110101
```

### Пример 2: Эмуляция карты

```bash
sudo ./gate-controller
# Выбираем опцию [2]
2
[+] Ожидаю номер карты в формате 093,12176
- Номер карты не должен иметь пробелов
- Номер карты не должен иметь никаких спец символов кроме [ , ]
: 093,12176
# Карта отправлена в контроллер
```

### Пример 3: Блокировка считывателя

```bash
sudo ./gate-controller
# Выбираем опцию [3]
3
Управление:
  1 - ЗАБЛОКИРОВАТЬ считыватель
  0 - РАЗБЛОКИРОВАТЬ считыватель
  Ctrl+C - Выход (авто-разблокировка)

[OK] БЛОКИРОВКА СНЯТА
Линии свободны. Система работает в штатном режиме.

Введите команду (1/0): 1

[!!!] БЛОКИРОВКА АКТИВНА
Линии Data 0 и Data 1 прижаты к GND.
Считыватель физически не может передать данные.

Введите команду (1/0): 0

[OK] БЛОКИРОВКА СНЯТА
Линии свободны. Система работает в штатном режиме.
```

---

## Устранение неполадок

### Ошибка: "Ошибка открытия GPIO"

**Причина:** Недостаточно прав для доступа к GPIO.

**Решение:**
```bash
sudo ./gate-controller
```

### Ошибка: "Необходимо передавать номер карты в формате: 090,76767"

**Причина:** Неверный формат ввода номера карты.

**Решение:** Убедитесь, что:
- Используется запятая в качестве разделителя
- Отсутствуют пробелы
- Оба числа являются целыми

### Контроллер не реагирует на отправленные карты

**Возможные причины:**
1. Неправильное подключение проводов (проверьте схему)
2. Неправильная нумерация GPIO (физические vs BCM)
3. Контроллер настроен на другой протокол

**Решение:**
- Проверьте подключение проводов
- Убедитесь, что используются GPIO 17 и 27 (BCM нумерация)
- Проверьте настройки контроллера Gate-IP-Base

---

## Безопасность

⚠️ **Важно:**
- Данный проект предназначен для тестирования и разработки систем контроля доступа
- Использование для несанкционированного доступа является незаконным
- Автор не несёт ответственности за неправомерное использование

---

## Планы развития

- [ ] HTTP API для удалённого управления
- [ ] Telegram бот для управления через мессенджер
- [ ] Поддержка других форматов Wiegand (34, 37 бит)
- [ ] Логирование всех операций
- [ ] Web-интерфейс для управления

---

## Лицензия

Проект распространяется "как есть" без каких-либо гарантий.

---

## Автор

GitHub: [@varavayka](https://github.com/varavayka)

---

## Полезные ссылки

- [Спецификация протокола Wiegand](https://en.wikipedia.org/wiki/Wiegand_interface)
- [Документация go-rpio](https://github.com/stianeikeland/go-rpio)
- [Raspberry Pi GPIO Pinout](https://pinout.xyz/)

---

## Дополнительная информация

### Как работает преобразование номера карты

При отправке номера карты программа автоматически:
1. Принимает десятичные числа (код объекта и номер карты)
2. Преобразует их в бинарный формат
3. Вычисляет биты чётности
4. Формирует полную 26-битную последовательность
5. Отправляет побитово с правильными таймингами

**Вам не нужно:**
- ❌ Вручную преобразовывать номера в двоичный код
- ❌ Высчитывать биты чётности
- ❌ Беспокоиться о таймингах импульсов

**Достаточно просто ввести:** `093,12176`

---

*Последнее обновление: 8 февраля 2026*
